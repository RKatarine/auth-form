name: Build and deploy
on:
  push:
    branches:
      - main
  pull_request:
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3
        with:
          # Fetch all git history so that yarn workspaces --since can compare with the correct commits
          # @link https://github.com/actions/checkout#fetch-all-history-for-all-tags-and-branches
          fetch-depth: 0

      - name: Set up Node.js ⚙️
        uses: actions/checkout@v3
        with:
          node-version: '18.x'
          cache: 'yarn'
          cache-dependency-path: yarn.lock

      - name: Set up SSH client 🔒
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - uses: benjlevesque/short-sha@v1.2
        id: short-sha

      - name: Install and Build 🔧
        working-directory: .
        run: |
          yarn install --frozen-lockfile
          yarn build
        env:
          VITE_COMMIT_HASH: '${{ steps.short-sha.outputs.sha }}'
          VITE_BASE_PUBLIC_PATH: '${{ secrets.VITE_BASE_PUBLIC_PATH }}'

      - name: Deploy 🚀
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          branch: main
          folder: dist
          target-folder: docs
          ssh-key: ${{ secrets.DEPLOY_KEY }}